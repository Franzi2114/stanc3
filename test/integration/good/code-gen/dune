(include ../dune)

(rule
 (targets cpp.output)
 (deps (package stanc) (:stanfiles eight_schools_ncp.stan one_var_per_block.stan))
 (action
  (with-stdout-to %{targets}
   (run %{bin:run_bin_on_args} "%{bin:stanc} --print-cpp" %{stanfiles}))))

(alias
 (name runtest)
 (action (diff cpp.expected cpp.output)))

(rule
  (targets eight_schools_ncp.hpp)
  (deps (package stanc))
  ;; (action (chdir %{env:cmdstan=cmdstan} (run make -j4 build)))
  (action (run %{bin:stanc} eight_schools_ncp.stan)))

(rule
  (targets eight_schools_ncp)
  (deps eight_schools_ncp.hpp)
  (action
  (chdir %{env:cmdstan=cmdstan}
    (run make -j4 %{targets}))))

(rule
 (targets eight_schools_ncp.csv)
 (action
   (run %{dep:eight_schools_ncp} random seed=1 sample data file=%{dep:eight_schools.data.R} output file=%{targets})))

(rule
 (targets eight_schools_ncp_summary.output)
 (deps eight_schools_ncp.csv)
 (action
   (with-stdout-to %{targets}
     (run %{env:cmdstan=cmdstan}/bin/stansummary %{deps}))))

(alias (name runtest)
  (enabled_if (<> false %{env:cmdstan=false}))
  (action (diff eight_schools_ncp_summary.expected eight_schools_ncp_summary.output)))
